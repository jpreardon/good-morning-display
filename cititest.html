<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Good Morning Display II - CITIBike Test</title>
        <link rel="manifest" href="manifest.json">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="application-name" content="GMD2">
        <meta name="apple-mobile-web-app-title" content="GMD2">
        <meta name="msapplication-starturl" content="https://jpreardon.com/gmd/index.html">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link href="styles/main.css" rel="stylesheet">
        <style>
            #station-info {
                font-size: xx-large;
            }
        </style>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script>
            const STATION_INFO_URL = "https://gbfs.citibikenyc.com/gbfs/en/station_information.json"
            const STATION_STATUS_URL = "https://gbfs.citibikenyc.com/gbfs/en/station_status.json"
            var stationlist = []

            function getStationList() {
                return new Promise( (resolve, reject) => {
                    $.getJSON( STATION_INFO_URL ) 
                    .done( (json) => {
                        
                        json.data.stations.forEach(station => {
                            stationlist.push( {name: station.name, id: station.station_id} )
                        });
                        
                        // Sort here
                        stationlist.sort(function (a, b) {
                            var nameA = a.name.toUpperCase()
                            var nameB = b.name.toUpperCase()
                            if ( nameA < nameB ) {
                                return -1
                            }
                            if ( nameA > nameB ) {
                                return 1
                            }

                            return 0
                        })

                        stationlist.forEach(station => {
                            document.getElementById("station-list").innerHTML += `<option value="${station.id}">${station.name}</option>`
                        })
                                             
                    })
                    .fail( (jqxhr, textStatus, error) => {
                        console.log(textStatus)
                    })
                })
            }

            function getStationInformation(id) {
                return new Promise( (resolve, reject) => {
                    $.getJSON( STATION_STATUS_URL ) 
                    .done( (json) => {
                        var station = json.data.stations.find(station => station.station_id == id)

                        var returnVal = `This station is <strong>${station.station_status}</strong> `

                        if ( station.is_renting == 1 && station.is_returning == 1 )  {
                            returnVal += "and renting and accepting returns.<br>"
                        } else if ( station.is_renting == 1 && station.is_returning == 0 ) {
                            returnVal += "and renting but not accepting returns.<br>"
                        } else if ( station.is_renting == 0 && station.is_returning == 0 ) {
                            returnVal += "but not renting or accepting returns.<br>"
                        } else if ( station.is_renting == 0 && station.is_returning == 1 ) {
                            returnVal += "but not renting, however, they'll accept returns.<br>"
                        }

                        returnVal += `Bikes: ${station.num_bikes_available}<br>`
                        returnVal += `eBikes: ${station.num_ebikes_available}<br>`
                        returnVal += `Docks: ${station.num_docks_available}<br>`
                        document.getElementById("station-info").innerHTML = returnVal                 
                    })
                    .fail( (jqxhr, textStatus, error) => {
                        console.log(textStatus)
                    })
                })
            }

            $(document).ready( () => {
                getStationList()
            })
        </script>
    </head>

    <body>
        <div id="container" class="settings-container">
            <h1>CITIBike Test</h1>
            <p>Let's get the Citibike data hooked up</p>
            <form>
                <select id="station-list" onchange="getStationInformation(this.selectedOptions[0].value)" aria-placeholder="select station">
                    <option>select a station...</option>
                </select>
                <div>
                    <p id="station-info"></p>
                </div>
            </form>
        </div>
</html>