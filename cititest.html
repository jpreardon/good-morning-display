<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Good Morning Display II - CITIBike Test</title>
        <link rel="shortcut icon" href="/images/apple-touch-icon.png" />
        <link rel="manifest" href="manifest.json">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="application-name" content="GMD2">
        <meta name="apple-mobile-web-app-title" content="GMD2">
        <meta name="msapplication-starturl" content="https://jpreardon.com/gmd/index.html">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link href="styles/main.css" rel="stylesheet">
        <style>
            #station-info {
                font-size: xx-large;
            }

            select {
                width: 250px;
            }
        </style>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <script>
            const STATION_INFO_URL = "https://gbfs.citibikenyc.com/gbfs/en/station_information.json"
            const STATION_STATUS_URL = "https://gbfs.citibikenyc.com/gbfs/en/station_status.json"
            const UPDATE_INTERVAL_SECONDS = 60
            var STATIONS_LOADED = false
            var LAST_UPDATE_TIME = 0

            function getStationList() {
                var time = Date.now()
                var stationlist = []
                return new Promise( (resolve, reject) => {
                    $.getJSON( STATION_INFO_URL ) 
                    .done( (json) => {
                        
                        json.data.stations.forEach(station => {
                            stationlist.push( {name: station.name, id: station.station_id} )
                        });

                        // Sort here
                        stationlist.sort(function (a, b) {
                            var nameA = a.name.toUpperCase()
                            var nameB = b.name.toUpperCase()
                            if ( nameA < nameB ) {
                                return -1
                            }
                            if ( nameA > nameB ) {
                                return 1
                            }

                            return 0
                        })

                        var optionValues = ""
                        stationlist.forEach(station => {
                            optionValues += `<option value="${station.id}">${station.name}</option>`
                        })
                        document.getElementById("station-list").innerHTML = optionValues

                        STATIONS_LOADED = true
                        resolve("success")
                        
                    })
                    .fail( (jqxhr, textStatus, error) => {
                        console.log(textStatus)
                    })
                })
            }

            function getStationInformation(collection) {
                return new Promise( (resolve, reject) => {
                    $.getJSON( STATION_STATUS_URL ) 
                    .done( (json) => {
                        var returnVal = ""
                        for (let item of collection) {
                            var station = json.data.stations.find(station => station.station_id == item.value)
                            returnVal += `<strong>${item.innerHTML}</strong><br>`
                            //returnVal += `Renting: ${station.is_renting}<br>`
                            //returnVal += `Returning: ${station.is_returning}<br>`
                            returnVal += `Bikes: ${station.num_bikes_available}<br>`
                            returnVal += `eBikes: ${station.num_ebikes_available}<br>`
                            //returnVal += `Docks: ${station.num_docks_available}<br><br>`
                            returnVal += "<br>"
                        }

                        document.getElementById("station-info").innerHTML = returnVal                                         
                    })
                    .fail( (jqxhr, textStatus, error) => {
                        console.log(textStatus)
                    })
                })
            }

            function addStations() {
                station_list = document.getElementById("station-list") 
                selected_stations =  document.getElementById("selected-stations")
                myItems = []

                // Collect items to move
                for (let item of station_list.selectedOptions) {
                    myItems.push(item)
                }

                // Move items
                myItems.forEach(item => {
                    selected_stations.options[selected_stations.options.length] = station_list.removeChild(station_list.options[item.index])
                })
            }

            function removeStations() {
                station_list = document.getElementById("station-list") 
                selected_stations =  document.getElementById("selected-stations")
                myItems = []

                // Collect items to move
                for (let item of selected_stations.selectedOptions) {
                    myItems.push(item)
                }

                // Move items
                myItems.forEach(item => {
                    station_list.options[station_list.options.length] = selected_stations.removeChild(selected_stations.options[item.index])
                })
            }

            function saveStations() {
                var stationIds = []
                var stationIdsJSON = ""

                // Put each of the list's values in an array
                for (let station of document.getElementById("selected-stations").options) {
                    stationIds.push(station.value)
                }
                
                // Create a JSON string of the array
                stationIdsJSON = JSON.stringify(stationIds)
            
                // Save the JSON to local storage
                localStorage.setItem("bikeStations", stationIdsJSON)
            }

            function getStations() {
                var stationIds = []
                var stationIdsJSON = ""
                var stations = []

                // Get JSON from local storage
                stationIdsJSON = localStorage.getItem("bikeStations")

                // Convert to an array
                stationIds = JSON.parse(stationIdsJSON)

                // Get the name for each of the IDs
                stationIds.forEach(id => {
                    for (let station of document.getElementById("station-list").options) {
                        if (station.value == id) {
                            stations.push([id, station.innerText])
                        }
                    }   
                })

                // Add an option to the selected stations list for each of the stations
                stations.forEach(station => {
                    var opt = document.createElement("option")
                    opt.value = station[0]
                    opt.text = station[1]
                    document.getElementById("selected-stations").add(opt)
                })

                // Remove those options from the station list
                for (let station of document.getElementById("station-list").options) {
                    if (stationIds.includes(station.value)) {
                        document.getElementById("station-list").removeChild(station)
                    }
                }

            }

            function updateDisplay() {
                if (STATIONS_LOADED && (Date.now() - LAST_UPDATE_TIME) > (UPDATE_INTERVAL_SECONDS * 1000)) {
                    getStations()
                    getStationInformation(document.getElementById("selected-stations").options)
                    LAST_UPDATE_TIME = Date.now()
                }
            }

            $(document).ready( () => {
                getStationList()
                setInterval(updateDisplay, 1000)
            })
            
        </script>
    </head>

    <body>
        <div id="container" class="settings-container">
            <h1>CITIBike Test</h1>
            <p>Let's get the Citibike data hooked up</p>
            <div>
                <p id="station-info"></p>
            </div>
            <select id="station-list" multiple></select>
            <button onclick="addStations()">&gt;</button>
            <button onclick="removeStations()">&lt;</button>
            <select id="selected-stations" multiple></select>
            <br>
            <button onclick="saveStations(document.getElementById('selected-stations').options)">Save Stations</button>
        </div>
</html>