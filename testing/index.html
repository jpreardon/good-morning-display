<!DOCTYPE html>
<html lang="en">
    <head>
        <title>MTA Testing</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <script type="text/javascript" src="protobuf.js"></script>
        <script type="text/javascript" src="mta-arrivals.js"></script>
        <script type="text/javascript" src="../javascript/utils.js"></script>
        <script>
            "use strict"
            function updateArrivals(gtfsStopId) {    
                getArrivalsForGtfsStopId(gtfsStopId)
                .then(arrivals => {
                    // Fill it up the HTML
                    var html = ""

                    Object.keys(arrivals).forEach(direction => {
                        if (arrivals[direction].label !== "") {
                            html += arrivals[direction].label
                            arrivals[direction].trains.forEach(arrival => { 
                                html += '<div class="train">'
                                html += `<p class="line _${arrival.line.toLowerCase()}">${arrival.line}</p>`
                                html += `<p class="destination">${arrival.destination}</p>`
                                    if (arrival.seconds <= 30) {
                                        html += '<p class="time arriving">ARRIVING</p>'
                                    } else {
                                        html += `<p class="time">${Number(arrival.seconds / 60).toFixed()} min</p>`
                                    }  
                                html += '</div>'
                            })
                        }
                    })

                    document.getElementById("arrivals").innerHTML = html
                })
                    
            }

            function ready(fn) {
                if (document.readyState !== 'loading') {
                    fn();
                } else {
                    document.addEventListener('DOMContentLoaded', fn);
                }
            }

            ready( () => {
                const STATION_ID = localStorage.getItem("subwayStation")
                // Get station information and load display
                initMtaArrivals()
                    .then(x => {
                        updateArrivals(STATION_ID)
                        document.getElementById("stop-name").innerHTML = getStationName(STATION_ID)
                        window.setInterval(updateArrivals, 1000 * 30, STATION_ID)
                    })
                    .catch(error => {
                        console.error(error)
                    })
            })

        </script>
        <style>
            
            body {
                font-family: sans-serif;
                background-color: black;
                color: white;
                margin: 1rem;
            }

            #arrivals {
                width: 100%;
            }

            .train {
                margin: 0.5rem 0;
                border: 1px solid white;
                padding: 0.25rem 0.75rem;
                border-radius: 3px;
            }            

            .line, .destination, .time {
                display: inline-block;
            }

            .line {
                font-weight: bold;
            }

            .destination {
                margin-left: 0.75rem;
            }

            .time {
                float: right;
            }

            h1 {
                font-size: 1.2rem;
            }

            #stop-name {
                font-size: 1rem;
                color: gray;
            }

            .arriving {
                color: red;
            }

            /* MTA Line decoration below, this can be reused, don't throw it out */

            .line {
                width: 1.5rem;
                height: 1.5rem;
                line-height: 1.7rem;
                text-align: center;
                border-radius: 50%;
                font-weight: bold;
            }

            ._a, ._c, ._e {
                background-color: #0039A6;
                color: #ffffff;
            }
            
            ._b, ._d, ._f, ._m {
                background-color: #FF6319;
                color: #ffffff;
            }

            ._g {
                background-color: #6CBE45;
                color: #ffffff;
            }

            ._j, ._z {
                background-color: #996633;
                color: #ffffff;
            }

            ._l {
                background-color: #A7A9AC;
                color: #ffffff;
            }

            ._n, ._q, ._r, ._w {
                background-color: #FCCC0A;
                color: black;
            }

            ._s {
                background-color: #808183;
                color: #ffffff;
            }

            ._1, ._2, ._3 {
                background-color: #EE352E;
                color: #ffffff;
            }

            ._4, ._5, ._6, ._6 {
                background-color: #00933C;
                color: #ffffff;
            }

            ._7 {
                background-color: #B933AD;
                color: #ffffff;
            }

            ._sir {
                font-size: 0.65rem;
                background-color: #0078C6;
                color: #ffffff;
            }

            /* End MTA Line decoration */

        </style>
    </head>
    <body>
        <h1>MTA Test</h1>
        <h2 id="stop-name"></h2>
        <div id="arrivals">

        </div>
        <a href="../settings.html">settings</a>
    </body>
</html>