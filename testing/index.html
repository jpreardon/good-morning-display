<html>
    <head>
        <title>MTA Test</title>
        <script type="text/javascript" src="protobuf.js"></script>
        <script type="text/javascript" src="complexes.js"></script>
        <script type="text/javascript" src="destinationComplex.js"></script>

        <script>
            //const path = require('path')
            //const fetch = require('node-fetch')
            const ProtoBuf = protobuf
            // TODO: This is here for testing only
            var feedme

            // Grab the destination information

            //const API_KEY = require('./api-key')
            const API_KEY = localStorage.getItem("mta-api-key")

            const API_URL = 'https://api-endpoint.mta.info/Dataservice/mtagtfsfeeds/nyct%2F'

            const STATION_ID = "D25" // D25 should be 7AV & Flatbush in BK

            /* const FEED_IDS = [
                'gtfs-ace',
                'gtfs-bdfm',
                'gtfs-g',
                'gtfs-jz',
                'gtfs-nqrw',
                'gtfs-l',
                'gtfs',
                'gtfs-7',
                'gtfs-si'
            ] */

            const FEED_IDS = [
                'gtfs-nqrw',
                'gtfs-bdfm'
            ]

            const protoBufDef = "nyct-subway.proto.txt"
            ProtoBuf.load(protoBufDef, (error, root) => {
                if (error) throw error
                const FeedMessage = root.lookupType('transit_realtime.FeedMessage')
                for (const feedID of FEED_IDS) {
                    const url = `${API_URL}${feedID}`
                    fetch(url, { headers: { 'x-api-key': API_KEY } })
                    .then(res => {
                        if (res.ok) {
                            return res
                        } else {
                            throw new Error(res.status)
                        }
                    })
                    .then(res => res.arrayBuffer())
                    .then(body => {
                        //const buf = Buffer.from(body)
                        const buf = new Uint8Array(body)
                        const feed = FeedMessage.decode(buf)
                        feedme = feed
                        for (const message of feed.entity) {
                            // Only look at tripUpdates
                            if (message.tripUpdate) {
                                // Loop through the stopTimeUpdates and only show those for the station we care about
                                for (const stopUpdate of message.tripUpdate.stopTimeUpdate) {
                                    if (stopUpdate.stopId.substr(0, stopUpdate.stopId.length - 1) == STATION_ID) {
                                        // Figure out number of minutes
                                        arrivalTime = new Date(stopUpdate.arrival.time * 1000)
                                        arrivalDiff = arrivalTime - Date.now()
                                        destinationId = message.tripUpdate.trip[".nyctTripDescriptor"].trainId.split("/")[1]
                                        destinationName = complexes[destinationComplex[destinationId]].name
                                        document.getElementById("arrivals").innerHTML += `${message.tripUpdate.trip.routeId} ${destinationName} - ${(arrivalDiff / 60 / 1000).toFixed(0)} minutes<br>`
                                    }
                                }
                            }
                        }
                    })
                }
            })
            
        </script>
    </head>
    <body>
        <h1>MTA Test</h1>
        <div id="arrivals">

        </div>
    </body>
</html>